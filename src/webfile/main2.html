<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>PDF Quantify Compress</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/mystyle.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/grayscale.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"
        type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body id="page-top" data-spy="scroll" data-target=".navbar-fixed-top">
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar navbar-custom navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse"
                        data-target=".navbar-main-collapse">
                        <i class="fa fa-bars"></i>
                    </button>
                    <a class="navbar-brand page-scroll" href="#page-top">
                        <i class="fa fa-play-circle"></i> <span class="light">Start</span> PDF Quantify Compress
                    </a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
                    <ul class="nav navbar-nav">
                        <!-- Hidden li included to remove active class from about link when scrolled up past about section -->
                        <li class="hidden">
                            <a href="#page-top"></a>
                        </li>
                        <li>
                            <a class="page-scroll" href="http://127.0.0.1:5500/index.html#about">About</a>
                        </li>
                        <li>
                            <a class="page-scroll" href="#download">Compress</a>
                        </li>
                        <li>
                            <a class="page-scroll" href="#contact">Developer</a>
                        </li>
                    </ul>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container -->
        </nav>


        <div class="content">
            <div class="box1">
                <div class="box2">
                    <img src="images/压缩图片.png" />
                    <h3>定向压缩</h3>
                    <span>将文件压缩到不超过指定大小的最佳质量</span>
                </div>

                <div class="box2">
                    <img src="images/分类.png" />
                    <h3>精确控制</h3>
                    <span>自定义每一个图片的压缩率</span>
                </div>

                <div class="box2">
                    <img src="images/便捷.png" />
                    <h3>便捷高效</h3>
                    <span>在线点击即用,处理迅速</span>
                </div>
            </div>

            <div class="addfile" @click="changeprocess">
                <img src="images/文件.png" />
                <h3 style="color: black;">选择文件</h3>

            </div>
        </div>

        <div class="box4" style="margin-top: 15px;">
            <img src="images/无数据.png" v-if="file.name=='未选择文件'" />
            <img src="images/pdf.png" v-else />
            <span style="margin-left: 30px;">选择需要压缩的文件:{{file.name}}</span>
            <button @click="uploadFile" class="rtx" v-if="file.name!='未选择文件'">上传</button>

        </div>

        <div class="box3" style="justify-content: center;" v-if="state>1">
            <span style="margin-left: 0px;">{{statext}}</span>
            <div class="loading-status">
                <div class="process" :style="{width: process + '%'}"></div>
            </div>
        </div>

        <div class="box4" v-if="state>2">
            <img src="images/pdf.png" />
            <span style="margin-left: 30px;">{{file.name}}</span>
            <span class="rtx">{{(file.size/1024).toFixed(3)}}KB</span>
            <button @click="compress">压缩</button>


        </div>

        <div class="box3" v-if="state>2">
            <span>文件可压缩范围:最大{{fileMaxSize.toFixed(3)}}KB--最小{{fileMinSize.toFixed(3)}}KB</span>
        </div>

        <div class="box5" v-if="state>2">
            <div class="box7">
                <span style="width: 300px;">预计图片压缩率:{{compressrate.toFixed(3)}}%</span>
                <span style="margin-left: 20px;">预计压缩后大小:{{compressedSize.toFixed(3)}}KB</span>
                <span style="margin-left: 20px;">预计PSNR:{{psnr.toFixed(3)}}</span>
                <span style="margin-left: 20px;">预计SSIM:{{ssim.toFixed(3)}}</span>
            </div>

            <div style="width: 90%;">
                <input type="range" min="0" max="960" class="rag" v-model="size" @change="sizeRateChange" />
            </div>


            <div class="box6">
                <span class="txt2" style="margin-left: 0;" title="图片数据完全损失的PDF文件体积">可压缩最小体积</span>
                <span class="txt2" title="不损失分辨率最小体积">极致压缩</span>
                <span class="txt2" title="压缩图片的质量较差,但是可以接受">推荐最低压缩体积</span>
                <span class="txt2" title="最佳压缩体积:压缩图片的质量较好,人眼看不出较大差别">最佳压缩体积</span>
                <span class="txt2" style="width: 10%;margin-left: -2%;" title="不对图片文件进行压缩">无损体积</span>
            </div>

            <div class="box5" style=" align-items:flex-start;">
                <span class="txt3">PSNR高于40dB说明图像质量极好,即非常接近原始图像
                    在30—40dB通常表示图像质量是好的即失真可以察觉但可以接受
                    在20—30dB说明图像质量差
                    最后PSNR低于20dB图像一般不可接受
                </span>
                <span class="txt3">SSIM > 0.9:图像质量非常好，失真几乎不可察觉。
                    0.7 < SSIM < 0.9:图像质量较好，存在轻微失真，但通常可以接受。 SSIM < 0.7:图像质量较差，失真明显。 SSIM < 0.5:图像质量非常差，失真严重。</span>
            </div>


        </div>

        <div class="box3" v-if="state>2" style="margin-top: 20px;margin-left: 30px;">
            <input type="checkbox" class="checkbox" v-model="maxlimit" />
            <span style="margin-left: 0;">限制目标文件最大大小(KB):</span>
            <input type="text" v-if="maxlimit" placeholder="输入文件最大体积(KB)" v-model="maxlimitsize"
                style="color: black;" />
        </div>

        <div class="box4" v-if="state>4">
            <img class="testimg" src="images/pdf.png" />
            <span style="margin-left: 30px;">{{upfilename}}</span>
            <span class="rtx">{{downloadsize.toFixed(3)}}KB</span>
            <button @click="downloadFile">下载</button>
        </div>

        <div class="box7" v-if="state>4">
            <span style="margin-left: 20px;">输出文件平均PSNR:{{dlpsnr.toFixed(3)}}</span>
            <span style="margin-left: 20px;">输出文件平均SSIM:{{dlssim.toFixed(3)}}</span>
        </div>

        <input ref="fileinput" type="file" @change="handleFileChange" class="filechose" />

    </div>




    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                //path:"47.104.6.104:80",
                path: "127.0.0.1:5000",
                title: '刘超',
                process: 0,
                size: 0,
                file: { "name": "未选择文件" }, // 存储选中的文件
                message: '', // 显示上传状态信息
                socket: null,
                state: 0,//0:未选择文件,1:待上传,2:正在解析,3:等待编辑压缩参数,4:正在压缩,5:下载文件
                statext: "正在上传文件",
                wsid: "",
                fileMaxSize: 0,
                fileMinSize: 0,
                fileImgSize: 0,
                compressedSize: 0,
                psnr: 0.0,
                ssim: 0.0,
                compressrate: 0,
                qual: 95,
                imgact: 0.0,
                maxlimit: false,
                maxlimitsize: 0.0,
                upfilename: "",
                downloadsize: 0
            },
            mounted() {
                // 初始化 WebSocket 连接

            },
            beforeDestroy() {
                // 关闭 WebSocket 连接
                this.socket.close();
            },
            methods: {
                sendinfo: function () {
                    axios.post("http://8.130.54.6/register", { username: "12345", password: "123" }, { "content-type": "application/json" })
                        .then(function (res) {
                            console.log(res)
                        })
                },
                changeprocess() {
                    this.process += 1
                    this.$refs.fileinput.click();
                },
                // 处理文件选择
                handleFileChange(event) {
                    this.file = event.target.files[0];
                    if (this.file.name != "未选择文件") this.state = 1;
                    else this.state = 0
                    console.log(this.file)
                },
                sendMessage() {
                    const message = 'Hello, WebSocket!';
                    this.socket.send(message);
                },
                scrollToBottom() {
                    window.scrollTo({
                        top: document.documentElement.scrollHeight,
                        behavior: 'smooth' // 可选，使滚动平滑
                    });
                },
                compress() {
                    this.state = 4
                    let url = '/compressfile'
                    //压缩过程:判断是否限制大小
                    if (this.maxlimit) {
                        url = '/compresstosize'
                    }
                    var that = this
                    axios.get(url, {
                        headers: {
                            'Accept': 'application/json'
                        },
                        params: {
                            uid: this.wsid, // 查询参数
                            filename: this.upfilename,
                            compressrate: this.qual,
                            maxsize: this.maxlimitsize,
                            imgrate: (this.maxlimitsize - this.fileMinSize) / this.imgact,
                            emptysize: this.fileMinSize
                        }
                    })
                        .then(response => {
                            console.log('Response data:', response.data);
                            that.downloadsize = response.data.size
                            that.dlpsnr = response.data.PSNR
                            that.dlssim = response.data.SSIM
                            //处理接收到的这部分数据
                            that.state = 5;
                            that.$nextTick(() => {
                                that.scrollToBottom();
                            });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });

                },
                sizeRateChange() {
                    //重新计算压缩后的大小
                    //305--615--925
                    //0--30--95
                    let qual = 0
                    if (this.size > 305 && this.size <= 615) {
                        qual = 30 * (this.size - 305) / 310
                    }
                    else if (this.size > 615 && this.size <= 925) {
                        qual = 65 * (this.size - 615) / 310 + 30
                    }
                    else qual = 0

                    this.qual = qual

                    this.compressrate = 4.5678e-05 * (qual ** 3) - 5.134e-03 * (qual ** 2) + 0.29 * qual + 7.7557e-03
                    this.psnr = 6.4875e-05 * (qual ** 3) - 9.718e-03 * (qual ** 2) + 0.53 * qual + 21.704
                    this.ssim = Math.log(qual + 1.1724) * 0.09702 + 0.5329
                    this.compressedSize = this.fileMinSize + this.compressrate * this.imgact * 0.01
                },
                // 上传文件
                uploadFile() {
                    console.log("开始上传文件")
                    this.state = 2//todo 上传之后需要开始解析(2-3),等待后端websocket信号
                    //this.scrollToBottom()//需要等待dom更新完再调用函数,否则无效
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });

                    if (!this.file) {
                        this.message = '请先选择一个文件！';
                        return;
                    }
                    console.log(this.file)
                    const formData = new FormData();
                    formData.append('file', this.file);
                    this.statext = "正在上传文件"
                    console.log(this.url)
                    axios.post('/upload', formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                        },
                        onUploadProgress: (progressEvent) => {
                            // 计算上传进度
                            const percentCompleted = Math.round(
                                (progressEvent.loaded * 100) / progressEvent.total
                            );
                            this.process = percentCompleted; // 更新进度
                        },
                    })
                        .then(response => {
                            this.message = response
                            console.log("返回消息:", this.message)
                            this.upfilename = this.message.data.filename
                            this.statext = "正在解析文件"
                            //文件上传完成,建立ws连接
                            this.buildWebSocket()


                        })
                        .catch(error => {
                            this.message = '上传失败：' + error.message;
                        });

                },
                parse_file() {
                    let that = this
                    axios.get('/parsefile', {
                        headers: {
                            'Accept': 'application/json'
                        },
                        params: {
                            uid: this.wsid, // 查询参数
                            filename: this.upfilename
                        }
                    })
                        .then(response => {
                            console.log('Response data:', response.data);
                            //处理接收到的这部分数据
                            that.fileMaxSize = response.data.filesize
                            that.fileMinSize = response.data.emptysize
                            that.fileImgSize = response.data.imgsize
                            that.imgact = response.data.imgact
                            that.compressedSize = response.data.filesize
                            that.state = 3
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                },
                async downloadFile() {
                    try {
                        // 发送 GET 请求到后端下载接口
                        const response = await fetch('/download?name=' + this.upfilename);
                        if (!response.ok) {
                            throw new Error('文件下载失败');
                        }

                        // 将响应内容转换为 Blob 对象
                        const blob = await response.blob();

                        // 创建一个临时链接
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;

                        // 设置下载文件的名称
                        link.setAttribute('download', this.upfilename);  // 替换为实际文件名

                        // 触发下载
                        document.body.appendChild(link);
                        link.click();

                        // 清理临时链接

                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('下载失败:', error);
                    }
                },
                buildWebSocket() {
                    this.socket = new WebSocket('ws://' + this.path + '/ws');
                    this.socket.onmessage = (event) => {
                        this.response = event.data;
                        console.log(this.response)
                        //获取到ws数据,根据type和wsid获取消息类型和
                        let mestype = this.response.split(':')[0]
                        if (mestype == 'id') {//处理uid信息
                            this.wsid = this.response.split(':')[1]
                            //发送文件解析请求(因为这里才获取到请求参数)
                            this.parse_file()
                        }
                        else if (mestype == 'reg') {//处理进度条请求
                            this.process = parseInt(this.response.split(':')[1])
                        }
                        else if (mestype == 'info') {//处理提示位置
                            this.statext = this.response.split(':')[1]
                        }
                        //console.log(mestype,this.wsid)
                    };

                    this.socket.onopen = () => {
                        console.log('WebSocket connected');


                    };

                    this.socket.onclose = () => {
                        console.log('WebSocket disconnected');
                    };
                },
            }
        })
    </script>
</body>

</html>